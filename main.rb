require 'socket'
require_relative 'atom'

def read_hosts(serv)
  loop do
    atom = Atom::read(serv)

    case atom.id4
    when 'host'
      atom.children.each do |child|
        case child.id4
        when 'upip', 'ip'
          str = [child.value].pack('N').bytes.join('.')
        else
          str = child.value.inspect
        end
        puts "#{child.id4}: #{str}"
      end
    when 'quit'
      break
    else
      p atom
    end
    puts
  end
end

include Atom

if ARGV.size != 3
  puts "Usage: ruby main.rb HOST PORT CHANNEL_ID"
  exit 1
end

host, port, channel_id = ARGV

serv = TCPSocket.new(host, port)
serv.write "GET /channel/#{channel_id} HTTP/1.0\r\nx-peercast-pcp:1\r\n\r\n"
while (line = serv.gets) != "\r\n"
  if line =~ /^HTTP/
    status = line.split[1]
  end
  p line.force_encoding('UTF-8')
end

require 'colorize'

def handshake(serv)
  helo = Atom::Parent.new(PCP_HELO)
  helo << Atom::String.new(PCP_HELO_AGENT, PCX_AGENT)
  helo << Atom::Integer.new(PCP_HELO_VERSION, 1218)
  helo << Atom::Bytes.new(PCP_HELO_SESSIONID, "1234567890123456")

  # HELO
  serv.write helo
  # OLEH
  atom = Atom::read(serv)
  p atom
end

case status
when '503'
  handshake(serv)
  read_hosts(serv)
when '200'
  handshake(serv)
  loop do
    atom = Atom::read(serv)
    if atom.id4 == 'chan'
      packet = atom['pkt']
      type = packet['type']
      data = packet['data']
      size = data.bytes.bytesize
      if size >= 15 * 1024
        s = ( "%6d" % size ).bold.red
      else
        s = ( "%6d" % size )
      end
      puts "#{type.bytes}: #{s}"
    else
      p atom
    end
  end
else
  fail 'don\'t know what to do'
end

=begin
p "oleh\x05\x00\x00\x80rip\x00\x04\x00\x00\x00\x973\x05nagnt\x18\x00\x00\x00PeerCastStation/1.8.0.0\x00sid\x00\x10\x00\x00\x00\x1F\xF16\xE2\xA9\xE1K\xF1\xAC\xC2\x10e\xFF\xC4Qhport\x02\x00\x00\x00\x00\x00ver\x00\x04\x00\x00\x00\xC2\x04\x00\x00host\x12\x00\x00\x80cid\x00\x10\x00\x00\x00\xE8\x8B\xE9+\xA9J!\xBDq\v\xEDQ\x99\xD9\xCE\xB5id\x00\x00\x10\x00\x00\x00\xC3\xFB\xF3p\xFC\xE4O\xBC\xBD\x82P\xCA\xC0\xFE\xF6\xDAnuml\x04\x00\x00\x00\x02\x00\x00\x00numr\x04\x00\x00\x00\x02\x00\x00\x00uptm\x04\x00\x00\x00\x90\x15\x00\x00ver\x00\x04\x00\x00\x00\xC2\x04\x00\x00vevp\x04\x00\x00\x00\e\x00\x00\x00vexp\x02\x00\x00\x00STvexn\x02\x00\x00\x00\xDC\x00flg1\x01\x00\x00\x00\x16upip\x04\x00\x00\x002\x97\xD41uppt\x04\x00\x00\x00\xE8\e\x00\x00oldp\x04\x00\x00\x00\f\xDF\x86\bnewp\x04\x00\x00\x00Fh\x88\bip\x00\x00\x04\x00\x00\x00\xCF\x12\x81\xD2port\x02\x00\x00\x00\xE8\eip\x00\x00\x04\x00\x00\x00|\x00\r\nport\x02\x00\x00\x00\xE8\ehost\x12\x00\x00\x80cid\x00\x10\x00\x00\x00\xE8\x8B\xE9+\xA9J!\xBDq\v\xEDQ\x99\xD9\xCE\xB5id\x00\x00\x10\x00\x00\x00{vgi\x83+M\xAE\xB2K=\xB6\xC0a\xEB\xA3numl\x04\x00\x00\x00\x01\x00\x00\x00numr\x04\x00\x00\x00\x01\x00\x00\x00uptm\x04\x00\x00\x00\x18\x15\x00\x00oldp\x04\x00\x00\x00H\x87\xB6\bnewp\x04\x00\x00\x00\xF6e\xB9\bver\x00\x04\x00\x00\x00\xC2\x04\x00\x00vevp\x04\x00\x00\x00\e\x00\x00\x00vexp\x02\x00\x00\x00STvexn\x02\x00\x00\x00\xDC\x00flg1\x01\x00\x00\x00\x16upip\x04\x00\x00\x00\xCF\x12\x81\xD2uppt\x04\x00\x00\x00\xE8\e\x00\x00ip\x00\x00\x04\x00\x00\x00P#\x06\xB4port\x02\x00\x00\x00\xE8\eip\x00\x00\x04\x00\x00\x00\x02\x01\xA8\xC0port\x02\x00\x00\x00\xE8\ehost\x12\x00\x00\x80cid\x00\x10\x00\x00\x00\xE8\x8B\xE9+\xA9J!\xBDq\v\xEDQ\x99\xD9\xCE\xB5id\x00\x00\x10\x00\x00\x00\xB9\xCCJ\xB0\x99\xE6B\xF5\xA3m\x01\x0F\x0Fdk\x82numl\x04\x00\x00\x00\x01\x00\x00\x00numr\x04\x00\x00\x00\x01\x00\x00\x00uptm\x04\x00\x00\x00{\x12\x00\x00ver\x00\x04\x00\x00\x00\xC2\x04\x00\x00vevp\x04\x00\x00\x00\e\x00\x00\x00vexp\x02\x00\x00\x00STvexn\x02\x00\x00\x00\xEA\x00flg1\x01\x00\x00\x00\x16upip\x04\x00\x00\x00\xF2\x8C\x86\xDFuppt\x04\x00\x00\x00\xE8\e\x00\x00oldp\x04\x00\x00\x00\xE4\x89\xA7\bnewp\x04\x00\x00\x003\xC3\xAA\bip\x00\x00\x04\x00\x00\x00\xC72\x84\xD2port\x02\x00\x00\x00\xE8\eip\x00\x00\x04\x00\x00\x00\x02\x00\xA8\xC0port\x02\x00\x00\x00\xE8\ehost\x13\x00\x00\x80cid\x00\x10\x00\x00\x00\xE8\x8B\xE9+\xA9J!\xBDq\v\xEDQ\x99\xD9\xCE\xB5id\x00\x00\x10\x00\x00\x00f7\xE1+A\xD6JJ\xA0\x13Ss\xCD\xB0\xBF\xD6numl\x04\x00\x00\x00\x01\x00\x00\x00numr\x04\x00\x00\x00\x00\x00\x00\x00uptm\x04\x00\x00\x00y\x15\x00\x00ver\x00\x04\x00\x00\x00\xC2\x04\x00\x00vevp\x04\x00\x00\x00\e\x00\x00\x00vexp\x02\x00\x00\x00STvexn\x02\x00\x00\x00\xC8\x00flg1\x01\x00\x00\x00\x16oldp\x04\x00\x00\x00\xEE\xA3\xA4\bnewp\x04\x00\x00\x00\xAC.\xA6\bupip\x04\x00\x00\x00P#\x06\xB4uppt\x04\x00\x00\x00\xE8\e\x00\x00uphp\x04\x00\x00\x00\x00\x00\x00\x00ip\x00\x00\x04\x00\x00\x00F\xD2\x1A=port\x02\x00\x00\x00\xE8\eip\x00\x00\x04\x00\x00\x00\x02\v\xA8\xC0port\x02\x00\x00\x00\xE8\ehost\x13\x00\x00\x80cid\x00\x10\x00\x00\x00\xE8\x8B\xE9+\xA9J!\xBDq\v\xEDQ\x99\xD9\xCE\xB5id\x00\x00\x10\x00\x00\x00\xB3\x9E\xC2+0TJ\xFD\x97\x95\x04\xE6\xE9\x16Phnuml\x04\x00\x00\x00\x01\x00\x00\x00numr\x04\x00\x00\x00\x00\x00\x00\x00uptm\x04\x00\x00\x00\xA9\x15\x00\x00ver\x00\x04\x00\x00\x00\xC2\x04\x00\x00vevp\x04\x00\x00\x00\e\x00\x00\x00vexp\x02\x00\x00\x00STvexn\x02\x00\x00\x00\xDC\x00flg1\x01\x00\x00\x00\x16oldp\x04\x00\x00\x006\x1D\xA8\bnewp\x04\x00\x00\x00Z\x03\xAB\bupip\x04\x00\x00\x00\xF2\x8C\x86\xDFuppt\x04\x00\x00\x00\xE8\e\x00\x00uphp\x04\x00\x00\x00\x00\x00\x00\x00ip\x00\x00\x04\x00\x00\x00\xF8\xCC\xA4\xDBport\x02\x00\x00\x00\xE8\eip\x00\x00\x04\x00\x00\x00\x02\x01\xA8\xC0port\x02\x00\x00\x00\xE8\ehost\x13\x00\x00\x80cid\x00\x10\x00\x00\x00\xE8\x8B\xE9+\xA9J!\xBDq\v\xEDQ\x99\xD9\xCE\xB5id\x00\x00\x10\x00\x00\x00w\xE8\x9E\xFA\xE1TCL\xBE\xC6$\xD2\xA3\x17\xDC\xBEnuml\x04\x00\x00\x00\x01\x00\x00\x00numr\x04\x00\x00\x00\x00\x00\x00\x00uptm\x04\x00\x00\x00\xB8\x15\x00\x00ver\x00\x04\x00\x00\x00\xC2\x04\x00\x00vevp\x04\x00\x00\x00\e\x00\x00\x00vexp\x02\x00\x00\x00STvexn\x02\x00\x00\x00\xDC\x00flg1\x01\x00\x00\x00\x16oldp\x04\x00\x00\x00s\x83\xA7\bnewp\x04\x00\x00\x00\x9B\xAA\xAA\bupip\x04\x00\x00\x00\xC72\x84\xD2uppt\x04\x00\x00\x00\xE8\e\x00\x00uphp\x04\x00\x00\x00\x00\x00\x00\x00ip\x00\x00\x04\x00\x00\x00\x8CG\x03\xB4port\x02\x00\x00\x00\xE8\eip\x00\x00\x04\x00\x00\x00\x03\x01\xA8\xC0port\x02\x00\x00\x00\xE8\ehost\x12\x00\x00\x80cid\x00\x10\x00\x00\x00\xE8\x8B\xE9+\xA9J!\xBDq\v\xEDQ\x99\xD9\xCE\xB5id\x00\x00\x10\x00\x00\x00\xCB'\xFAY\xCBKG\x9A\x93\xA8\x01\xDD\xD8LU/numl\x04\x00\x00\x00\x01\x00\x00\x00numr\x04\x00\x00\x00\x00\x00\x00\x00uptm\x04\x00\x00\x006\x11\x00\x00ver\x00\x04\x00\x00\x00\xC2\x04\x00\x00vevp\x04\x00\x00\x00\e\x00\x00\x00vexp\x02\x00\x00\x00STvexn\x02\x00\x00\x00\xEA\x00flg1\x01\x00\x00\x00\x16upip\x04\x00\x00\x00\x88\x94\x02$uppt\x04\x00\x00\x00\xE8\e\x00\x00oldp\x04\x00\x00\x00Y}\xA0\bnewp\x04\x00\x00\x00K\x9E\xA2\bip\x00\x00\x04\x00\x00\x00\xB6\xFD\xE8\x99port\x02\x00\x00\x00\xE8\eip\x00\x00\x04\x00\x00\x00\x02\x00\xA8\xC0port\x02\x00\x00\x00\xE8\ehost\x13\x00\x00\x80cid\x00\x10\x00\x00\x00\xE8\x8B\xE9+\xA9J!\xBDq\v\xEDQ\x99\xD9\xCE\xB5id\x00\x00\x10\x00\x00\x00$\x9C\xFE$6\xB0N\\\x9F\x7F\xA6Cxn\xCC\xF1numl\x04\x00\x00\x00\x01\x00\x00\x00numr\x04\x00\x00\x00\x00\x00\x00\x00uptm\x04\x00\x00\x00\xB6\x10\x00\x00ver\x00\x04\x00\x00\x00\xC2\x04\x00\x00vevp\x04\x00\x00\x00\e\x00\x00\x00vexp\x02\x00\x00\x00STvexn\x02\x00\x00\x00\xDC\x00flg1\x01\x00\x00\x00\x16oldp\x04\x00\x00\x00\xA7R\xA4\bnewp\x04\x00\x00\x00R\xF5\xA5\bupip\x04\x00\x00\x00\xF2\x8C\x86\xDFuppt\x04\x00\x00\x00\xE8\e\x00\x00uphp\x04\x00\x00\x00\x00\x00\x00\x00ip\x00\x00\x04\x00\x00\x00Z\xBFc~port\x02\x00\x00\x00\xE8\eip\x00\x00\x04\x00\x00\x00d\n\xA8\xC0port\x02\x00\x00\x00\xE8\equit\x04\x00\x00\x00\xEB\x03\x00\x00".size
=end
